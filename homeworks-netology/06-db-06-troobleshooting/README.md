# Ответы на задания 06-db-06-troobleshooting   
## Задача 1  
Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).
Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 
Вы как инженер поддержки решили произвести эту операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.
## Решение 1 
Согласно официального manual в СУБД MongoDB для диагности и прерывания операции существуют следующие методы:  
> Terminates an operation as specified by the operation ID. To find operations and their corresponding IDs, see $currentOp or db.currentOp().
> The db.killOp() method has the following parameter:
>- Parameter: op
>- Type: number
>- Description: An operation ID. 

Таким образом, сперва необходимо определить запрос, длительностью в 3 минуты, затем прервать его с помощью приведенного выше метода.  

Для решения вопроса с долгими(зависающими) запросами в MongoDB, согласно официальной документации существует следующий метод:  
> The maxTimeMS() method sets a time limit for an operation. When the operation reaches the specified time limit, MongoDB interrupts the operation at the next interrupt point.  
## Задача 2  
Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).
Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 
При масштабировании сервиса до N реплик вы увидели, что:
- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.
Как вы думаете, в чём может быть проблема?  
## Решение 2  
Без поднятия описанной инфраструктуры, моделирования ситуации и чтения логов достаточно тяжело определить в чем именно проблема, посему стал бы действовать, исходя из необходимости диагностики и реализации первичных мер, описанных на странице документации [Redis latency troobleshooting](https://redis.io/topics/latency):  
- Использовать функцию SLOWLOG  
- Отключение transparent_hugepage в ядре  
- Диагностика задержек на уровне ВМ (в случае ее использования)  
- Включение latency monitoring с помощью команды:
```
CONFIG SET latency-monitor-threshold 100
```
как описано на странице документации [Redis latency monitoring](https://redis.io/docs/management/optimization/latency-monitor/). Цифра зависит от длительности запросов, больше которой (в мс) необходимо мониторить.  
Без мониторинга о сути проблемы можно догадываться и предполагать. Это могут быть ошибки сети передачи данных, ошибки самого приложения, связанные с неверной работой механизма TTL.  
## Задача 3  
Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```
Как вы думаете, почему это начало происходить и как локализовать проблему?  
Какие пути решения этой проблемы вы можете предложить?
## Решение 3  
Отвечая на первый вопрос стоит предположить, что геоинформационная система (если я правильно понимаю, что имеется в виду в условии задачи) - приложение, предполагающее систематический рост объема БД. Приведенная в условии ошибка по моему мнению может происходить из-за проблем с сетью (необходимо смотреть не растет ли число пакетов с ошибками) - в этом случае проблема с коммутаторами или коммутацией. Если с сетью все хорошо, скорее всего проблема с длительностью выборки данных из таблицы возрошего объема - смотреть необходимо конфигурацию MySQL и мониторить утилизацию ресурсов сервера.  
Пути решения данной проблемы описаны в [официальной документации на странице](https://dev.mysql.com/doc/refman/8.0/en/error-lost-connection.html). Наиболее вероятно, нужно обратить внимание на параметр *net_read_timeout* и, что менее вероятно, на параметры *connect_timeout* и *max_allowed_packet*. Увеличение их значений скорее всего решит возникшую проблему, но вряд ли повысит удовлетворенность пользователей из-за долгого ожидания ответов.  
## Задача 4  
Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.
После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:
`postmaster invoked oom-killer`
Как вы думаете, что происходит?  
Как бы вы решили эту проблему?
## Решение 4  
Скорее всего проблемы с RAM и SWAP. В первую очередь необходимо выполнить на сервере команду:
```
free -h
```
и помониторить утилизацию данных ресурсов. При возможности расширения объема вычислительных ресурсов - выделить. При невозможности выполнить команду:
```
cat /proc/sys/vm/panic_on_oom
```
и посмотреть вывод. Значение 0 позволит избежать поведения kernel panic при утилизации RAM.  

